import os, hashlib
from linebot import LineBotApi
from linebot.models import FlexSendMessage, TextSendMessage, QuickReply, QuickReplyButton, MessageAction
from googleapiclient.discovery import build
from user.models import LineProfile
from user.utils import get_valid_google_credentials

# LINE Bot API Ë®≠ÂÆö
CHANNEL_TOKEN = os.getenv("CHANNEL_TOKEN")
line_bot_api = LineBotApi(CHANNEL_TOKEN)


def hash_code(plain_code: str) -> str:
    return hashlib.sha256(plain_code.encode("utf-8")).hexdigest()


def reply_text(reply_token: str, text: str) -> None:
    try:
        line_bot_api.reply_message(reply_token, TextSendMessage(text=text))
    except Exception as e:
        print(f"LINE reply Â§±Êïó: {e}")


def push_to_group(group_id: str, text: str) -> bool:
    try:
        line_bot_api.push_message(group_id, TextSendMessage(text=text))
        return True
    except Exception as e:
        print(f"Êé®Êí≠Âà∞Áæ§ÁµÑÂ§±Êïó: {e}")
        return False

def send_course_created_message(line_user_id: str, course_name: str, gc_course_id: str, enrollment_code: str, alternate_link: str = None):
    """
    ÁôºÈÄÅË™≤Á®ãÂâµÂª∫ÊàêÂäüÁöÑFlex Message
    """
    
    # Âª∫Á´ãÊåâÈàï
    buttons = []
    if alternate_link:
        buttons.append({
            "type": "button",
            "style": "primary",
            "action": {
                "type": "uri",
                "label": "Âú® Google Classroom ‰∏≠ÈñãÂïü",
                "uri": alternate_link
            }
        })
    
    # Â¶ÇÊûúÊ≤íÊúâÈÄ£ÁµêÔºåÂèØ‰ª•Êîæ‰∏ÄÂÄãËøîÂõû‰∏ªÈÅ∏ÂñÆÁöÑÊåâÈàï
    buttons.append({
        "type": "button",
        "style": "secondary",
        "margin": "sm",
        "action": {
            "type": "message",
            "label": "ËøîÂõû‰∏ªÈÅ∏ÂñÆ",
            "text": "‰∏ªÈÅ∏ÂñÆ"
        }
    })

    flex_message = {
        "type": "bubble",
        "body": {
            "type": "box",
            "layout": "vertical",
            "paddingAll": "0px",
            "backgroundColor": "#FFFFFF",
            "contents": [
                # È†ÇÈÉ®Êº∏Â±§ËÉåÊôØÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "32px",
                    "paddingBottom": "24px",
                    "backgroundColor": "#2196F3",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "md",
                            "alignItems": "center",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "üéì",
                                    "size": "3xl",
                                    "align": "center"
                                },
                                {
                                    "type": "text",
                                    "text": "Ë™≤Á®ãÂâµÂª∫ÊàêÂäüÔºÅ",
                                    "size": "xl",
                                    "weight": "bold",
                                    "color": "#FFFFFF",
                                    "align": "center",
                                    "margin": "sm"
                                },
                                {
                                    "type": "text",
                                    "text": f"Ë™≤Á®ãÔºö{course_name}",
                                    "size": "md",
                                    "color": "#E3F2FD",
                                    "align": "center",
                                    "wrap": True
                                }
                            ]
                        }
                    ]
                },
                # Ë™≤Á®ãË≥áË®äÂç°Áâá
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "lg",
                            "contents": [
                                # Ë™≤Á®ãID
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "spacing": "md",
                                    "paddingAll": "16px",
                                    "backgroundColor": "#F8F9FA",
                                    "cornerRadius": "12px",
                                    "contents": [
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 0,
                                            "alignItems": "center",
                                            "justifyContent": "center",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "üÜî",
                                                    "size": "xl"
                                                }
                                            ]
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 1,
                                            "spacing": "xs",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "Ë™≤Á®ãID",
                                                    "size": "xs",
                                                    "color": "#6C757D",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": gc_course_id,
                                                    "size": "sm",
                                                    "color": "#2196F3",
                                                    "weight": "bold"
                                                }
                                            ]
                                        }
                                    ]
                                },
                                # Ë®ªÂÜäÁ¢º
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "spacing": "md",
                                    "paddingAll": "16px",
                                    "backgroundColor": "#F8F9FA",
                                    "cornerRadius": "12px",
                                    "contents": [
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 0,
                                            "alignItems": "center",
                                            "justifyContent": "center",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "üîë",
                                                    "size": "xl"
                                                }
                                            ]
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 1,
                                            "spacing": "xs",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "Ë®ªÂÜäÁ¢º",
                                                    "size": "xs",
                                                    "color": "#6C757D",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": enrollment_code,
                                                    "size": "sm",
                                                    "color": "#2196F3",
                                                    "weight": "bold"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                # ÂàÜÈöîÁ∑ö
                {
                    "type": "separator",
                    "color": "#E9ECEF",
                    "margin": "none"
                },
                # Êìç‰ΩúÊåâÈàï
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "spacing": "md",
                    "contents": buttons
                }
            ]
        }
    }
    
    try:
        line_bot_api.push_message(
            line_user_id,
            FlexSendMessage(alt_text="Ë™≤Á®ãÂâµÂª∫ÊàêÂäü", contents=flex_message)
        )
        # print("Ë™≤Á®ãÂâµÂª∫ÊàêÂäüË®äÊÅØÂ∑≤Ë®ªËß£")
        return True
    except Exception as e:
        print(f"ÁôºÈÄÅË™≤Á®ãÂâµÂª∫Ê∂àÊÅØÂ§±Êïó: {e}")
        return False

def send_homework_created_message(line_user_id: str, homework_title: str, course_name: str, due_date: str, gc_course_id: str, alternate_link: str = None, homework_description: str = ""):
    """
    ÁôºÈÄÅ‰ΩúÊ•≠ÂâµÂª∫ÊàêÂäüÁöÑFlex Message
    """
    
    # Ë®≠ÂÆöÈÄ£ÁµêÔºåÂÑ™ÂÖà‰ΩøÁî® alternate_linkÔºåÂê¶Ââá‰ΩøÁî®Ë™≤Á®ãÈÄ£Áµê
    assignment_link = alternate_link if alternate_link else f"https://classroom.google.com/c/{gc_course_id}"
    
    # ËôïÁêÜ‰ΩúÊ•≠ÊèèËø∞ÔºåÂ¶ÇÊûúÁÇ∫Á©∫ÂâáÈ°ØÁ§∫È†êË®≠Ë®äÊÅØ
    if not homework_description or homework_description.strip() == "":
        homework_description = "Ë´ã‰æùÁÖßËÄÅÂ∏´ÁöÑÊåáÁ§∫ÂÆåÊàê‰ΩúÊ•≠"
    
    flex_message = {
        "type": "bubble",
        "header": {
            "type": "box",
            "layout": "horizontal",
            "contents": [
                {
                    "type": "text",
                    "text": "Êñ∞‰ΩúÊ•≠ÈÄöÁü•",
                    "weight": "bold",
                    "color": "#ffffff",
                    "size": "md"
                },
                {
                    "type": "text",
                    "text": course_name,
                    "color": "#ffffff",
                    "weight": "bold",
                    "size": "md",
                    "align": "end"
                }
            ],
            "backgroundColor": "#0367D3"
        },
        "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
                {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                        {
                            "type": "text",
                            "text": "NEW",
                            "size": "xs",
                            "align": "center",
                            "color": "#ffffff",
                            "gravity": "center"
                        }
                    ],
                    "position": "absolute",
                    "flex": 0,
                    "width": "48px",
                    "height": "25px",
                    "backgroundColor": "#EC3D44",
                    "cornerRadius": "100px",
                    "paddingAll": "2px",
                    "paddingStart": "4px",
                    "paddingEnd": "4px",
                    "offsetTop": "18px",
                    "offsetStart": "18px"
                },
                {
                    "type": "text",
                    "text": "üìù",
                    "margin": "none",
                    "size": "3xl",
                    "align": "center"
                },
                {
                    "type": "text",
                    "text": homework_title,
                    "weight": "bold",
                    "size": "xl",
                    "margin": "md",
                    "align": "center"
                },
                {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "separator",
                                    "margin": "lg"
                                }
                            ]
                        },
                        {
                            "type": "text",
                            "text": "Êà™Ê≠¢Êó•Êúü",
                            "size": "sm",
                            "align": "center",
                            "weight": "bold"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "separator",
                                    "margin": "lg"
                                }
                            ]
                        }
                    ],
                    "margin": "xxl"
                },
                {
                    "type": "text",
                    "text": f"{due_date} 23:59",
                    "color": "#ff5551",
                    "size": "sm",
                    "weight": "bold",
                    "align": "center",
                    "margin": "md"
                },
                {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "separator",
                                    "margin": "lg"
                                }
                            ]
                        },
                        {
                            "type": "text",
                            "text": "‰ΩúÊ•≠Ë™™Êòé",
                            "size": "sm",
                            "align": "center",
                            "weight": "bold"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "separator",
                                    "margin": "lg"
                                }
                            ]
                        }
                    ],
                    "margin": "xxl"
                },
                {
                    "type": "box",
                    "layout": "vertical",
                    "margin": "md",
                    "spacing": "sm",
                    "contents": [
                        {
                            "type": "text",
                            "text": homework_description,
                            "size": "sm",
                            "color": "#555555",
                            "wrap": True
                        }
                    ]
                },
                {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "text",
                            "text": "ÂâçÂæÄGoogle Classroom",
                            "action": {
                                "type": "uri",
                                "label": "ÈñãÂïü‰ΩúÊ•≠",
                                "uri": assignment_link
                            },
                            "align": "center",
                            "gravity": "center",
                            "color": "#ffffff",
                            "weight": "bold"
                        }
                    ],
                    "backgroundColor": "#0367D3",
                    "cornerRadius": "md",
                    "margin": "xxl",
                    "paddingTop": "xl",
                    "paddingBottom": "xl"
                }
            ]
        },
        "styles": {
            "footer": {
                "separator": True
            }
        }
    }
    
    try:
        line_bot_api.push_message(
            line_user_id,
            FlexSendMessage(alt_text="‰ΩúÊ•≠ÂâµÂª∫ÊàêÂäü", contents=flex_message)
        )
        # print("‰ΩúÊ•≠ÂâµÂª∫ÊàêÂäüË®äÊÅØÂ∑≤Ë®ªËß£")
        return True
    except Exception as e:
        print(f"ÁôºÈÄÅ‰ΩúÊ•≠ÂâµÂª∫Ê∂àÊÅØÂ§±Êïó: {e}")
        return False

def send_quick_reply(line_user_id: str):
    """
    ÁôºÈÄÅ Quick Reply ÊåâÈàïË®äÊÅØ
    """
    message = TextSendMessage(
        text=" ",  # ‰ΩøÁî®ÂÖ®ÂΩ¢Á©∫Ê†ºÔºåË¶ñË¶∫‰∏äÂπæ‰πéÁúã‰∏çÂà∞
        quick_reply=QuickReply(
            items=[
                QuickReplyButton(action=MessageAction(label="Êü•ÁúãÁè≠Á¥ö", text="Êü•ÁúãÊàëÁöÑÁè≠Á¥ö")),
                QuickReplyButton(action=MessageAction(label="Êñ∞Â¢û‰ΩúÊ•≠", text="ÊàëË¶ÅÊñ∞Â¢û‰ΩúÊ•≠")),
                QuickReplyButton(action=MessageAction(label="Ë™≤Â†ÇÊèêÂïè", text="ÊàëË¶ÅÊèêÂïè")),
                QuickReplyButton(action=MessageAction(label="Âª∫Á´ãË™≤Á®ã", text="ÊàëË¶ÅÂª∫Á´ã‰∏ÄÂÄãÁè≠Á¥ö")),
            ]
        )
    )

    try:
        line_bot_api.push_message(line_user_id, message)
        # print("Quick Reply Ë®äÊÅØÂ∑≤Ë®ªËß£")
        return True
    except Exception as e:
        print(f"ÁôºÈÄÅ Quick Reply Ê∂àÊÅØÂ§±Êïó: {e}")
        return False

def send_courses_list(line_user_id: str):
    """
    Âæû Google Classroom Áç≤ÂèñË™≤Á®ãÂàóË°®‰∏¶ÁôºÈÄÅ Flex Message
    """
    try:
        # Áç≤ÂèñÁî®Êà∂Ë≥áÊñô
        profile = LineProfile.objects.get(line_user_id=line_user_id)
        
        # Áç≤ÂèñÊúâÊïàÁöÑ Google ÊÜëË≠âÔºàËá™ÂãïËôïÁêÜÂà∑Êñ∞Ôºâ
        try:
            creds = get_valid_google_credentials(profile)
        except Exception as e:
            print(f"Google ÊÜëË≠âÁç≤ÂèñÂ§±Êïó (Áî®Êà∂: {line_user_id}): {str(e)}")
            return False
        
        # Âª∫Á´ã Google Classroom service
        service = build("classroom", "v1", credentials=creds, cache_discovery=False)
        
        # Áç≤ÂèñË™≤Á®ãÂàóË°®
        courses_response = service.courses().list(
            courseStates=["ACTIVE"],
            pageSize=10
        ).execute()
        
        courses = courses_response.get("courses", [])
        
        if not courses:
            # Ê≤íÊúâË™≤Á®ãÊôÇÁöÑ Flex Message
            flex_message = {
                "type": "bubble",
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "backgroundColor": "#FFFFFF",
                    "contents": [
                        {
                            "type": "text",
                            "text": "üìö",
                            "size": "3xl",
                            "align": "center"
                        },
                        {
                            "type": "text",
                            "text": "ÁõÆÂâçÊ≤íÊúâË™≤Á®ã",
                            "size": "lg",
                            "weight": "bold",
                            "align": "center",
                            "margin": "md"
                        },
                        {
                            "type": "text",
                            "text": "‰Ω†ÈÇÑÊ≤íÊúâÂª∫Á´ã‰ªª‰ΩïË™≤Á®ãÔºåÊàñÂ∞öÊú™Âä†ÂÖ•‰ªª‰ΩïË™≤Á®ã„ÄÇ",
                            "size": "sm",
                            "color": "#666666",
                            "align": "center",
                            "wrap": True
                        }
                    ]
                }
            }
        else:
            # ÊúâË™≤Á®ãÊôÇÁöÑ Flex Message
            course_contents = []
            
            for course in courses:
                course_content = {
                    "type": "box",
                    "layout": "horizontal",
                    "spacing": "md",
                    "paddingAll": "16px",
                    "backgroundColor": "#F8F9FA",
                    "cornerRadius": "12px",
                    "margin": "sm",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "flex": 0,
                            "alignItems": "center",
                            "justifyContent": "center",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "üéì",
                                    "size": "xl"
                                }
                            ]
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "flex": 1,
                            "spacing": "xs",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": course.get("name", "Êú™ÂëΩÂêçË™≤Á®ã"),
                                    "size": "md",
                                    "weight": "bold",
                                    "color": "#2196F3"
                                },
                                {
                                    "type": "text",
                                    "text": course.get("section", "ÁÑ°ÊèèËø∞"),
                                    "size": "sm",
                                    "color": "#666666",
                                    "wrap": True
                                },
                                {
                                    "type": "text",
                                    "text": f"Ë™≤Á®ãID: {course.get('id', 'N/A')}",
                                    "size": "xs",
                                    "color": "#999999"
                                }
                            ]
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "flex": 0,
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "link",
                                    "height": "sm",
                                    "action": {
                                        "type": "postback",
                                        "label": "ÈÅ∏Êìá",
                                        "data": f"course:{course.get('id', '')}",
                                        "displayText": f"{course.get('id', '')} {course.get('name', 'Êú™ÂëΩÂêçË™≤Á®ã')}"
                                    }
                                }
                            ]
                        }
                    ]
                }
                course_contents.append(course_content)
            
            flex_message = {
                "type": "bubble",
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "0px",
                    "backgroundColor": "#FFFFFF",
                    "contents": [
                        # È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü
                        {
                            "type": "box",
                            "layout": "vertical",
                            "paddingAll": "24px",
                            "paddingBottom": "16px",
                            "backgroundColor": "#2196F3",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "üìö",
                                    "size": "3xl",
                                    "align": "center"
                                },
                                {
                                    "type": "text",
                                    "text": "‰Ω†ÁöÑË™≤Á®ãÂàóË°®",
                                    "size": "xl",
                                    "weight": "bold",
                                    "color": "#FFFFFF",
                                    "align": "center",
                                    "margin": "sm"
                                },
                                {
                                    "type": "text",
                                    "text": f"ÂÖ±ÊâæÂà∞ {len(courses)} ÂÄãË™≤Á®ã",
                                    "size": "sm",
                                    "color": "#E3F2FD",
                                    "align": "center"
                                }
                            ]
                        },
                        # Ë™≤Á®ãÂàóË°®
                        {
                            "type": "box",
                            "layout": "vertical",
                            "paddingAll": "16px",
                            "contents": course_contents
                        }
                    ]
                }
            }
        
        # ÁôºÈÄÅ Flex Message
        line_bot_api.push_message(
            line_user_id,
            FlexSendMessage(alt_text="Ë™≤Á®ãÂàóË°®", contents=flex_message)
        )
        # print("Ë™≤Á®ãÂàóË°®Ë®äÊÅØÂ∑≤Ë®ªËß£")
        return True
        
    except LineProfile.DoesNotExist:
        print(f"Áî®Êà∂ {line_user_id} ‰∏çÂ≠òÂú®")
        return False
    except Exception as e:
        print(f"Áç≤ÂèñË™≤Á®ãÂàóË°®Â§±Êïó: {e}")
        return False 

def send_create_course_guide(line_user_id: str):
    """
    ÁôºÈÄÅÂª∫Á´ãË™≤Á®ãÁöÑÊåáÂºïË®äÊÅØ
    """
    flex_message = {
        "type": "bubble",
        "body": {
            "type": "box",
            "layout": "vertical",
            "paddingAll": "0px",
            "backgroundColor": "#FFFFFF",
            "contents": [
                # È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "paddingBottom": "16px",
                    "backgroundColor": "#4CAF50",
                    "contents": [
                        {
                            "type": "text",
                            "text": "üéì",
                            "size": "3xl",
                            "align": "center"
                        },
                        {
                            "type": "text",
                            "text": "Âª∫Á´ãÊñ∞Ë™≤Á®ã",
                            "size": "xl",
                            "weight": "bold",
                            "color": "#FFFFFF",
                            "align": "center",
                            "margin": "sm"
                        },
                        {
                            "type": "text",
                            "text": "Âú® Google Classroom Âª∫Á´ãÊñ∞Ë™≤Á®ã",
                            "size": "sm",
                            "color": "#E8F5E8",
                            "align": "center"
                        }
                    ]
                },
                # ÂÖßÂÆπÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "contents": [
                        {
                            "type": "text",
                            "text": "Ë´ãÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËº∏ÂÖ•Ôºö",
                            "size": "md",
                            "weight": "bold",
                            "color": "#333333",
                            "margin": "md"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "margin": "lg",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "Âª∫Á´ãË™≤Á®ã Ë™≤Á®ãÂêçÁ®±",
                                    "size": "sm",
                                    "color": "#4CAF50",
                                    "weight": "bold",
                                    "wrap": True
                                },
                                {
                                    "type": "text",
                                    "text": "‰æãÂ¶ÇÔºöÂª∫Á´ãË™≤Á®ã Á®ãÂºèË®≠Ë®àÊ¶ÇË´ñ",
                                    "size": "xs",
                                    "color": "#666666",
                                    "wrap": True
                                }
                            ]
                        },
                        {
                            "type": "separator",
                            "margin": "lg"
                        },
                        {
                            "type": "text",
                            "text": "üí° ÊèêÁ§∫ÔºöË™≤Á®ãÊúÉËá™ÂãïÂú® Google Classroom ‰∏≠Âª∫Á´ã",
                            "size": "xs",
                            "color": "#4CAF50",
                            "wrap": True
                        }
                    ]
                }
            ]
        }
    }
    
    try:
        line_bot_api.push_message(
            line_user_id,
            FlexSendMessage(alt_text="Âª∫Á´ãË™≤Á®ãÊåáÂºï", contents=flex_message)
        )
        # print("Âª∫Á´ãË™≤Á®ãÊåáÂºïË®äÊÅØÂ∑≤Ë®ªËß£")
        return True
    except Exception as e:
        print(f"ÁôºÈÄÅÂª∫Á´ãË™≤Á®ãÊåáÂºïÂ§±Êïó: {e}")
        return False

def send_add_homework_guide(line_user_id: str):
    """
    ÁôºÈÄÅÊñ∞Â¢û‰ΩúÊ•≠ÁöÑÊåáÂºïË®äÊÅØ
    """
    flex_message = {
        "type": "bubble",
        "body": {
            "type": "box",
            "layout": "vertical",
            "paddingAll": "0px",
            "backgroundColor": "#FFFFFF",
            "contents": [
                # È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "paddingBottom": "16px",
                    "backgroundColor": "#FF6B35",
                    "contents": [
                        {
                            "type": "text",
                            "text": "üìö",
                            "size": "3xl",
                            "align": "center"
                        },
                        {
                            "type": "text",
                            "text": "Êñ∞Â¢û‰ΩúÊ•≠",
                            "size": "xl",
                            "weight": "bold",
                            "color": "#FFFFFF",
                            "align": "center",
                            "margin": "sm"
                        },
                        {
                            "type": "text",
                            "text": "ÁÇ∫ÊåáÂÆöË™≤Á®ãÂª∫Á´ãÊñ∞‰ΩúÊ•≠",
                            "size": "sm",
                            "color": "#FFE8E0",
                            "align": "center"
                        }
                    ]
                },
                # ÂÖßÂÆπÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "contents": [
                        {
                            "type": "text",
                            "text": "Ë´ãÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËº∏ÂÖ•Ôºö",
                            "size": "md",
                            "weight": "bold",
                            "color": "#333333",
                            "margin": "md"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "margin": "lg",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "Êñ∞Â¢û‰ΩúÊ•≠ Ë™≤Á®ãID ‰ΩúÊ•≠Ê®ôÈ°å Âà∞ÊúüÊó•Êúü",
                                    "size": "sm",
                                    "color": "#FF6B35",
                                    "weight": "bold",
                                    "wrap": True
                                },
                                {
                                    "type": "text",
                                    "text": "‰æãÂ¶ÇÔºöÊñ∞Â¢û‰ΩúÊ•≠ 1234567890 ÊúüÊú´Â†±Âëä 2024-01-15",
                                    "size": "xs",
                                    "color": "#666666",
                                    "wrap": True
                                }
                            ]
                        },
                        {
                            "type": "separator",
                            "margin": "lg"
                        },
                        {
                            "type": "text",
                            "text": "üí° ÊèêÁ§∫ÔºöÂèØ‰ª•ÂÖàÈªûÊìä„ÄåÊü•ÁúãÁè≠Á¥ö„ÄçÁç≤ÂèñË™≤Á®ãID",
                            "size": "xs",
                            "color": "#FF6B35",
                            "wrap": True
                        }
                    ]
                }
            ]
        }
    }
    
    try:
        line_bot_api.push_message(
            line_user_id,
            FlexSendMessage(alt_text="Êñ∞Â¢û‰ΩúÊ•≠ÊåáÂºï", contents=flex_message)
        )
        # print("Êñ∞Â¢û‰ΩúÊ•≠ÊåáÂºïË®äÊÅØÂ∑≤Ë®ªËß£")
        return True
    except Exception as e:
        print(f"ÁôºÈÄÅÊñ∞Â¢û‰ΩúÊ•≠ÊåáÂºïÂ§±Êïó: {e}")
        return False

def send_ask_question_guide(line_user_id: str):
    """
    ÁôºÈÄÅË™≤Â†ÇÊèêÂïèÁöÑÊåáÂºïË®äÊÅØ
    """
    flex_message = {
        "type": "bubble",
        "body": {
            "type": "box",
            "layout": "vertical",
            "paddingAll": "0px",
            "backgroundColor": "#FFFFFF",
            "contents": [
                # È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "paddingBottom": "16px",
                    "backgroundColor": "#9C27B0",
                    "contents": [
                        {
                            "type": "text",
                            "text": "‚ùì",
                            "size": "3xl",
                            "align": "center"
                        },
                        {
                            "type": "text",
                            "text": "Ë™≤Â†ÇÊèêÂïè",
                            "size": "xl",
                            "weight": "bold",
                            "color": "#FFFFFF",
                            "align": "center",
                            "margin": "sm"
                        },
                        {
                            "type": "text",
                            "text": "Êúâ‰ªª‰ΩïÂïèÈ°åÈÉΩÂèØ‰ª•Ë©¢Âïè",
                            "size": "sm",
                            "color": "#F3E5F5",
                            "align": "center"
                        }
                    ]
                },
                # ÂÖßÂÆπÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "contents": [
                        {
                            "type": "text",
                            "text": "Ë´ãÁõ¥Êé•Ëº∏ÂÖ•‰Ω†ÁöÑÂïèÈ°åÔºö",
                            "size": "md",
                            "weight": "bold",
                            "color": "#333333",
                            "margin": "md"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "margin": "lg",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "‰æãÂ¶ÇÔºöÂ¶Ç‰ΩïÂª∫Á´ãÊñ∞ÁöÑË™≤Á®ãÔºü",
                                    "size": "sm",
                                    "color": "#9C27B0",
                                    "wrap": True
                                },
                                {
                                    "type": "text",
                                    "text": "‰æãÂ¶ÇÔºöÂ¶Ç‰ΩïÊñ∞Â¢û‰ΩúÊ•≠Ôºü",
                                    "size": "sm",
                                    "color": "#9C27B0",
                                    "wrap": True
                                },
                                {
                                    "type": "text",
                                    "text": "‰æãÂ¶ÇÔºöÂ¶Ç‰Ωï‰ΩøÁî®ÈÄôÂÄãÁ≥ªÁµ±Ôºü",
                                    "size": "sm",
                                    "color": "#9C27B0",
                                    "wrap": True
                                }
                            ]
                        },
                        {
                            "type": "separator",
                            "margin": "lg"
                        },
                        {
                            "type": "text",
                            "text": "üí° ÊèêÁ§∫ÔºöAI ÊúÉÊ†πÊìö‰Ω†ÁöÑÂïèÈ°åÊèê‰æõÂçîÂä©",
                            "size": "xs",
                            "color": "#9C27B0",
                            "wrap": True
                        }
                    ]
                }
            ]
        }
    }
    
    try:
        line_bot_api.push_message(
            line_user_id,
            FlexSendMessage(alt_text="Ë™≤Â†ÇÊèêÂïèÊåáÂºï", contents=flex_message)
        )
        # print("Ë™≤Â†ÇÊèêÂïèÊåáÂºïË®äÊÅØÂ∑≤Ë®ªËß£")
        return True
    except Exception as e:
        print(f"ÁôºÈÄÅË™≤Â†ÇÊèêÂïèÊåáÂºïÂ§±Êïó: {e}")
        return False

def send_course_binding_success_message(group_id: str, course_id: str, bound_by_line_user_id: str = ""):
    """
    ÁôºÈÄÅË™≤Á®ãÁ∂ÅÂÆöÊàêÂäüÁöÑFlex MessageÂà∞Áæ§ÁµÑ
    """
    try:
        # ÂæûÊú¨Âú∞Êï∏ÊìöÂ∫´Áç≤ÂèñË™≤Á®ã‰ø°ÊÅØ
        from course.models import Course
        try:
            local_course = Course.objects.get(gc_course_id=course_id)
            course_name = local_course.name
            enrollment_code = local_course.enrollment_code
            course_description = local_course.description or f"Ê≠°ËøéÂä†ÂÖ• {course_name}ÔºÅ"
            section_info = local_course.section or ""
            try:
                teacher_name = local_course.owner.name or "ËÄÅÂ∏´"
            except:
                teacher_name = "ËÄÅÂ∏´"
        except Course.DoesNotExist:
            # Â¶ÇÊûúÊú¨Âú∞Ê≤íÊúâÔºå‰ΩøÁî®È†êË®≠‰ø°ÊÅØ
            course_name = f"Ë™≤Á®ã {course_id}"
            enrollment_code = ""
            course_description = "Ê≠°ËøéÂä†ÂÖ•ÈÄôÂÄãË™≤Á®ãÔºÅ"
            section_info = ""
            teacher_name = "ËÄÅÂ∏´"
        
        # Áç≤ÂèñÁ∂ÅÂÆöËÄÖÂêçÁ®±
        bound_by_name = "Á≥ªÁµ±ÁÆ°ÁêÜÂì°"
        if bound_by_line_user_id:
            try:
                from user.models import LineProfile
                bound_by_profile = LineProfile.objects.get(line_user_id=bound_by_line_user_id)
                bound_by_name = bound_by_profile.name or bound_by_profile.line_user_id
            except LineProfile.DoesNotExist:
                bound_by_name = "Êú™Áü•Áî®Êà∂"
        
        # ÁîüÊàêÂä†ÂÖ•Ë™≤Á®ãÁöÑÈÄ£Áµê - Âº∑Âà∂‰ΩøÁî®ÈÇÄË´ãÁ¢ºÔºåÁ¢∫‰øùÂèØË¢´Áõ¥Êé•ÈÇÄË´ãÂÖ•Áè≠
        join_link = f"https://classroom.google.com/c/{course_id}?cjc={enrollment_code}"
        
        flex_message = {
            "type": "bubble",
            "header": {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                    {
                        "type": "text",
                        "text": "Áæ§ÁµÑÁ∂ÅÂÆöÊàêÂäü",
                        "weight": "bold",
                        "color": "#ffffff",
                        "size": "md"
                    },
                    {
                        "type": "text",
                        "text": "üéì",
                        "color": "#ffffff",
                        "size": "lg",
                        "align": "end"
                    }
                ],
                "backgroundColor": "#4CAF50"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {
                                "type": "text",
                                "text": "NEW",
                                "size": "xs",
                                "align": "center",
                                "color": "#ffffff",
                                "gravity": "center"
                            }
                        ],
                        "position": "absolute",
                        "flex": 0,
                        "width": "48px",
                        "height": "25px",
                        "backgroundColor": "#FF5722",
                        "cornerRadius": "100px",
                        "paddingAll": "2px",
                        "paddingStart": "4px",
                        "paddingEnd": "4px",
                        "offsetTop": "18px",
                        "offsetStart": "18px"
                    },
                    {
                        "type": "text",
                        "text": "üéâ",
                        "margin": "none",
                        "size": "3xl",
                        "align": "center"
                    },
                    {
                        "type": "text",
                        "text": course_name,
                        "weight": "bold",
                        "size": "xl",
                        "margin": "md",
                        "align": "center",
                        "wrap": True
                    }
                ]
            }
        }
        
        # Â¶ÇÊûúÊúâÁè≠Á¥öË≥áË®äÔºåÈ°ØÁ§∫Âá∫‰æÜ
        if section_info:
            flex_message["body"]["contents"].append({
                "type": "text",
                "text": section_info,
                "size": "sm",
                "color": "#666666",
                "align": "center",
                "margin": "sm",
                "wrap": True
            })
        
        # Ê∑ªÂä†Ë™≤Á®ãË≥áË®äÂàÜÈöîÁ∑öÂíåË™≤Á®ãID
        flex_message["body"]["contents"].extend([
            {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                    {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "separator",
                                "margin": "lg"
                            }
                        ]
                    },
                    {
                        "type": "text",
                        "text": "Ë™≤Á®ãË≥áË®ä",
                        "size": "sm",
                        "align": "center",
                        "weight": "bold"
                    },
                    {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "separator",
                                "margin": "lg"
                            }
                        ]
                    }
                ],
                "margin": "xxl"
            },
            {
                "type": "text",
                "text": f"Ë™≤Á®ãÂêçÁ®±Ôºö{course_name}",
                "color": "#4CAF50",
                "size": "sm",
                "weight": "bold",
                "align": "center",
                "margin": "md"
            }
        ])
        
        # Ê∑ªÂä†ÂÖ•Áè≠Ë≥áË®äÂàÜÈöîÁ∑öÂíåË®ªÂÜäÁ¢º
        flex_message["body"]["contents"].extend([
            {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                    {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "separator",
                                "margin": "lg"
                            }
                        ]
                    },
                    {
                        "type": "text",
                        "text": "ÂÖ•Áè≠Ë≥áË®ä",
                        "size": "sm",
                        "align": "center",
                        "weight": "bold"
                    },
                    {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "separator",
                                "margin": "lg"
                            }
                        ]
                    }
                ],
                "margin": "xxl"
            },
            {
                "type": "text",
                "text": f"Ë®ªÂÜäÁ¢ºÔºö{enrollment_code}",
                "color": "#FF9800",
                "size": "sm",
                "weight": "bold",
                "align": "center",
                "margin": "md"
            },
            {
                "type": "text",
                "text": "Â≠∏ÁîüÂèØ‰ΩøÁî®Ê≠§Ë®ªÂÜäÁ¢ºÂä†ÂÖ•Ë™≤Á®ã",
                "color": "#666666",
                "size": "xs",
                "align": "center",
                "margin": "xs"
            }
        ])
        
        # Ê∑ªÂä†ÂâçÂæÄÊåâÈàï
        flex_message["body"]["contents"].extend([
            {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": "ÂâçÂæÄGoogle Classroom",
                        "action": {
                            "type": "uri",
                            "label": "Âä†ÂÖ•Ë™≤Á®ã",
                            "uri": join_link
                        },
                        "align": "center",
                        "gravity": "center",
                        "color": "#ffffff",
                        "weight": "bold"
                    }
                ],
                "backgroundColor": "#4CAF50",
                "cornerRadius": "md",
                "margin": "xxl",
                "paddingTop": "xl",
                "paddingBottom": "xl"
            },
            {
                "type": "text",
                "text": f"Á∂ÅÂÆöËÄÖÔºö{bound_by_name}",
                "color": "#999999",
                "size": "xs",
                "align": "center",
                "margin": "md"
            }
        ])
        
        # Âä†ÂÖ• styles
        flex_message["styles"] = {
            "footer": {
                "separator": True
            }
        }
        
        line_bot_api.push_message(
            group_id,
            FlexSendMessage(alt_text="Ë™≤Á®ãÁ∂ÅÂÆöÊàêÂäü", contents=flex_message)
        )
        return True
        
    except Exception as e:
        print(f"ÁôºÈÄÅË™≤Á®ãÁ∂ÅÂÆöÊàêÂäüË®äÊÅØÂ§±Êïó: {e}")
        return False

def send_multiple_homework_created_message(line_user_id: str, homework_title: str, due_date: str, results: list, errors: list = None):
    """
    ÁôºÈÄÅÂ§öÂÄã‰ΩúÊ•≠ÂâµÂª∫ÊàêÂäüÁöÑFlex Message
    """
    if errors is None:
        errors = []
    
    success_count = len(results)
    total_count = success_count + len(errors)
    
    # ÊßãÂª∫ÊàêÂäüË™≤Á®ãÁöÑÂÖßÂÆπ
    course_contents = []
    for result in results:
        
        # ÁÇ∫ÊØèÂÄãÊàêÂäüÁöÑ‰ΩúÊ•≠Âª∫Á´ãÊåâÈàï
        buttons = []
        if result.get("alternate_link"):
            buttons.append({
                "type": "button",
                "style": "link",
                "height": "sm",
                "action": {
                    "type": "uri",
                    "label": "Êü•Áúã‰ΩúÊ•≠",
                    "uri": result.get("alternate_link")
                }
            })

        course_content = {
            "type": "box",
            "layout": "horizontal",
            "spacing": "md",
            "paddingAll": "16px",
            "backgroundColor": "#F8F9FA",
            "cornerRadius": "12px",
            "margin": "sm",
            "contents": [
                {
                    "type": "box",
                    "layout": "vertical",
                    "flex": 0,
                    "alignItems": "center",
                    "justifyContent": "center",
                    "contents": [
                        {
                            "type": "text",
                            "text": "‚úÖ",
                            "size": "xl"
                        }
                    ]
                },
                {
                    "type": "box",
                    "layout": "vertical",
                    "flex": 1,
                    "spacing": "xs",
                    "contents": [
                        {
                            "type": "text",
                            "text": result["course_name"],
                            "size": "md",
                            "weight": "bold",
                            "color": "#4CAF50"
                        },
                        {
                            "type": "text",
                            "text": f"Ë™≤Á®ãID: {result['course_id']}",
                            "size": "xs",
                            "color": "#666666"
                        }
                    ]
                },
                {
                    "type": "box",
                    "layout": "vertical",
                    "flex": 0,
                    "contents": buttons
                }
            ]
        }
        course_contents.append(course_content)
    
    # ÊßãÂª∫Â§±ÊïóË™≤Á®ãÁöÑÂÖßÂÆπ
    error_contents = []
    for error in errors:
        error_content = {
            "type": "box",
            "layout": "horizontal",
            "spacing": "md",
            "paddingAll": "16px",
            "backgroundColor": "#FFF3E0",
            "cornerRadius": "12px",
            "margin": "sm",
            "contents": [
                {
                    "type": "box",
                    "layout": "vertical",
                    "flex": 0,
                    "alignItems": "center",
                    "justifyContent": "center",
                    "contents": [
                        {
                            "type": "text",
                            "text": "‚ùå",
                            "size": "xl"
                        }
                    ]
                },
                {
                    "type": "box",
                    "layout": "vertical",
                    "flex": 1,
                    "spacing": "xs",
                    "contents": [
                        {
                            "type": "text",
                            "text": f"Ë™≤Á®ã {error['course_id']}",
                            "size": "md",
                            "weight": "bold",
                            "color": "#FF9800"
                        },
                        {
                            "type": "text",
                            "text": "ÂâµÂª∫Â§±Êïó",
                            "size": "xs",
                            "color": "#666666"
                        }
                    ]
                }
            ]
        }
        error_contents.append(error_content)
    
    # ÊßãÂª∫Flex Message
    flex_message = {
        "type": "bubble",
        "body": {
            "type": "box",
            "layout": "vertical",
            "paddingAll": "0px",
            "backgroundColor": "#FFFFFF",
            "contents": [
                # È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "32px",
                    "paddingBottom": "24px",
                    "backgroundColor": "#FF6B35",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "md",
                            "alignItems": "center",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "üìö",
                                    "size": "3xl",
                                    "align": "center"
                                },
                                {
                                    "type": "text",
                                    "text": "‰ΩúÊ•≠ÂâµÂª∫ÂÆåÊàêÔºÅ",
                                    "size": "xl",
                                    "weight": "bold",
                                    "color": "#FFFFFF",
                                    "align": "center",
                                    "margin": "sm"
                                },
                                {
                                    "type": "text",
                                    "text": f"ÊàêÂäüÂâµÂª∫Ôºö{success_count}/{total_count} ÂÄãË™≤Á®ã",
                                    "size": "md",
                                    "color": "#FFE8E0",
                                    "align": "center",
                                    "wrap": True
                                }
                            ]
                        }
                    ]
                },
                # ‰ΩúÊ•≠Ë≥áË®äÂç°Áâá
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "lg",
                            "contents": [
                                # ‰ΩúÊ•≠Ê®ôÈ°å
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "spacing": "md",
                                    "paddingAll": "16px",
                                    "backgroundColor": "#F8F9FA",
                                    "cornerRadius": "12px",
                                    "contents": [
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 0,
                                            "alignItems": "center",
                                            "justifyContent": "center",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "üìù",
                                                    "size": "xl"
                                                }
                                            ]
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 1,
                                            "spacing": "xs",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "‰ΩúÊ•≠Ê®ôÈ°å",
                                                    "size": "xs",
                                                    "color": "#6C757D",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": homework_title,
                                                    "size": "sm",
                                                    "color": "#FF6B35",
                                                    "weight": "bold"
                                                }
                                            ]
                                        }
                                    ]
                                },
                                # Âà∞ÊúüÊôÇÈñì
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "spacing": "md",
                                    "paddingAll": "16px",
                                    "backgroundColor": "#F8F9FA",
                                    "cornerRadius": "12px",
                                    "contents": [
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 0,
                                            "alignItems": "center",
                                            "justifyContent": "center",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "‚è∞",
                                                    "size": "xl"
                                                }
                                            ]
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "flex": 1,
                                            "spacing": "xs",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "Âà∞ÊúüÊôÇÈñì",
                                                    "size": "xs",
                                                    "color": "#6C757D",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": f"{due_date} 23:59",
                                                    "size": "sm",
                                                    "color": "#FF6B35",
                                                    "weight": "bold"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                # ÂàÜÈöîÁ∑ö
                {
                    "type": "separator",
                    "color": "#E9ECEF",
                    "margin": "none"
                },
                # Ë™≤Á®ãÂàóË°®
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "contents": [
                        {
                            "type": "text",
                            "text": "üìã Ë™≤Á®ãÂàóË°®",
                            "size": "md",
                            "weight": "bold",
                            "color": "#343A40",
                            "margin": "md"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": course_contents + error_contents
                        }
                    ]
                },
                # Êìç‰ΩúÊåâÈàï
                {
                    "type": "box",
                    "layout": "vertical",
                    "paddingAll": "24px",
                    "spacing": "md",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "primary",
                                    "action": {
                                        "type": "uri",
                                        "label": "ÂâçÂæÄ Google Classroom",
                                        "uri": "https://classroom.google.com"
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    }
    
    try:
        line_bot_api.push_message(
            line_user_id,
            FlexSendMessage(alt_text="Â§öÂÄã‰ΩúÊ•≠ÂâµÂª∫ÊàêÂäü", contents=flex_message)
        )
        # print("Â§öÂÄã‰ΩúÊ•≠ÂâµÂª∫ÊàêÂäüË®äÊÅØÂ∑≤Ë®ªËß£")
        return True
    except Exception as e:
        print(f"ÁôºÈÄÅÂ§öÂÄã‰ΩúÊ•≠ÂâµÂª∫Ê∂àÊÅØÂ§±Êïó: {e}")
        return False
