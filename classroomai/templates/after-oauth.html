<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è¨»å†Šå®Œæˆï¼Œæ­£åœ¨è¿”å›èª²ç¨‹ç®¡ç†â€¦</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- å¼·åˆ¶é˜²å¿«å–ï¼šç¢ºä¿ä¸æœƒå› ç‚ºå¿«å–å•é¡Œå°è‡´å›åˆ°è¨»å†Šé  -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body{display:flex;flex-direction:column;align-items:center;justify-content:center;
         height:100vh;font-family:sans-serif;background:#f0f9ff}
    .success-icon{font-size:4rem;margin-bottom:1rem}
    .title{color:#059669;font-size:1.5rem;font-weight:bold;margin-bottom:0.5rem}
    .message{color:#065f46;margin-bottom:1rem}
    .link{color:#0369a1;text-decoration:none}
    .link:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="success-icon">ğŸ‰</div>
  <h2 class="title">è¨»å†Šå®Œæˆï¼</h2>
  <p class="message">æ­£åœ¨è¿”å›èª²ç¨‹ç®¡ç†æ‡‰ç”¨â€¦</p>
  <a id="back" href="#" class="link">è‹¥æœªè‡ªå‹•è·³è½‰ï¼Œè«‹é»æ­¤è¿”å›</a>

  <script>
    const qs = new URLSearchParams(location.search);
    const liffId = qs.get('liff_id');
    const status = qs.get('status') || 'success';
    
    // è¨»å†Šå®Œæˆå¾Œï¼Œç›´æ¥è·³è½‰åˆ°èª²ç¨‹ç®¡ç†é¦–é ï¼Œä¸å†ç¶“éè¨»å†Šç‹€æ…‹æª¢æŸ¥
    // ä½¿ç”¨ home ä½œç‚º redirect åƒæ•¸ï¼Œè®“å‰ç«¯ç›´æ¥è·³è½‰åˆ°é¦–é 
    const cacheBust = Date.now().toString();
    const params = new URLSearchParams({ 
      status: 'registered', 
      redirect: 'home', 
      cb: cacheBust,
      registered: 'true'  // æ˜ç¢ºæ¨™ç¤ºå·²è¨»å†Šå®Œæˆ
    });

    // ä¸»è¦æ·±é€£çµï¼ˆç›´æ¥å–šèµ· LINE App å…§çš„ LIFF ä¸¦è·³è½‰åˆ°é¦–é ï¼‰
    const lineDeepLink = `line://app/${liffId}?${params.toString()}`;
    // HTTP å¾Œå‚™ï¼ˆè‹¥ç€è¦½å™¨æ””é˜» line:// å”è­°ï¼Œæ”¹ç”¨å®˜æ–¹ HTTP å…¥å£ï¼‰
    const lineHttpLink = `https://line.me/R/app/${liffId}?${params.toString()}`;

    function returnToCourseManagement() {
      try {
        console.log('è¨»å†Šå®Œæˆï¼Œæ­£åœ¨è¿”å›èª²ç¨‹ç®¡ç†é¦–é ...');
        // ä½¿ç”¨ replace é¿å…æŠŠæ­¤é åŠ å…¥æ­·å²ç´€éŒ„
        location.replace(lineDeepLink);
        
        // è‹¥ 1 ç§’å…§æœªæˆåŠŸè·³è½‰ï¼Œå˜—è©¦ HTTP å¾Œå‚™
        setTimeout(() => {
          console.log('å˜—è©¦ HTTP å¾Œå‚™é€£çµ...');
          location.replace(lineHttpLink);
        }, 1000);
      } catch (e) {
        console.error('è·³è½‰å¤±æ•—ï¼Œä½¿ç”¨æœ€çµ‚å¾Œå‚™æ–¹æ¡ˆ:', e);
        // æœ€çµ‚å¾Œå‚™ï¼šå°å‘ HTTP å…¥å£
        location.href = lineHttpLink;
      }
    }

    // 1. ç«‹å³è·³å› LINE èª²ç¨‹ç®¡ç†æ‡‰ç”¨
    returnToCourseManagement();

    // 2. 1.5 ç§’å¾Œå˜—è©¦é—œé–‰åˆ†é ï¼ˆå¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹ï¼‰
    setTimeout(() => {
      try { 
        window.close(); 
        console.log('å˜—è©¦é—œé–‰è¦–çª—');
      } catch (e) {
        console.log('ç„¡æ³•é—œé–‰è¦–çª—:', e);
      }
    }, 1500);

    // 3. æä¾›æ‰‹å‹•é»æ“Šå‚™æ´ï¼ˆä½¿ç”¨ HTTP å…¥å£ï¼ŒæˆåŠŸç‡è¼ƒé«˜ï¼‰
    document.getElementById('back').href = lineHttpLink;
    document.getElementById('back').onclick = function(e) {
      e.preventDefault();
      returnToCourseManagement();
    };

    // 4. é˜²æ­¢é é¢è¢«å¿«å–ï¼Œç¢ºä¿æ¯æ¬¡éƒ½æ˜¯æœ€æ–°çš„è·³è½‰é‚è¼¯
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
        console.log('é é¢å¾å¿«å–è¼‰å…¥ï¼Œé‡æ–°åŸ·è¡Œè·³è½‰é‚è¼¯');
        returnToCourseManagement();
      }
    });
  </script>
</body>
</html>
